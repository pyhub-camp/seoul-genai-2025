# 검증기반 Supabase Edge Functions PRD
**작성일: 2025-09-04**

## 🎯 프로젝트 목표
- **주요 사용자**: 서울시 공무원
- **목적**: 공공 데이터 활용, 업무 자동화, 시민 서비스 개선  
- **운영 환경**: Supabase Edge Functions + Deno Runtime
- **핵심 원칙**: 한 번에 오류 없는 배포 보장

## 🏗️ 표준 아키텍처 (3-Layer Pattern)

모든 function은 다음 구조를 준수:
- **lib.ts**: 순수 비즈니스 로직 (HTTP 독립적, 재사용 가능)
- **index.ts**: Edge Function HTTP 래퍼 (CORS, 에러 처리만)  
- **cli.ts**: 개발/테스트용 CLI (lib.ts import)

## 💼 구현 예정 Functions (주요 6개)

**naver-news-crawler**: 특정 키워드 네이버 뉴스 검색 (GET)
- 사용자: 홍보기획관, 시민소통기획관, 각 실·본부 정책담당
- 데이터: 네이버 뉴스 웹페이지 크롤링 (API 미제공)
- 제공 형태: HTML 파싱 (fetch() + DOM 분석)
- 기능: 최신 기사 제목, 링크, 요약, 핵심 키워드 반환
- 주의사항: User-Agent 헤더 설정, Rate Limit 고려

**seoul-population-api**: 서울시 구별 인구 데이터 조회 (GET)
- 사용자: 도시계획과, 정책기획관
- 데이터: 서울열린데이터광장 Open API (data.seoul.go.kr)
- API 형식: http://openAPI.seoul.go.kr:8088/[인증키]/json/[서비스명]/[시작]/[종료]
- 필요사항: API 인증키 (회원가입 후 발급), 인구/가구 카테고리 271개 데이터셋

**air-quality-api**: 실시간 미세먼지 정보 조회 (GET)  
- 사용자: 환경정책실, 보건환경연구원
- 데이터: 한국환경공단 에어코리아 Open API (data.go.kr)
- 주요 API: 대기오염정보, 대기오염 예보정보, 대기오염통계 현황
- 필요사항: 공공데이터포털 API키, 트래픽 제한(개발용 500건/일, 운영용 증설 가능)

**public-wifi-finder**: 공공 와이파이 위치 검색 (GET)
- 사용자: 디지털정책관, 정보화기획단  
- 데이터: 서울열린데이터광장 + 공공데이터포털 (전국무료와이파이 표준데이터)
- 제공 형태: CSV/JSON 파일 + API
- 좌표계: WGS84, SEOUL_Secure 설치 위치 정보 (2025년 6월 기준)

**civil-complaint-stats**: 민원 통계 분석 및 트렌드 (GET)
- 사용자: 시민소통기획관, 각 구청 민원실
- 데이터: 국민권익위원회 민원빅데이터 분석정보 API (data.go.kr)
- 제공 형태: Open API (2024년 버전)
- 필요사항: 공공데이터포털 API키, 제한(개발 100건, 운영 증설 가능, 최대 1000건/요청)

**policy-impact-analyzer**: 정책 효과 분석 및 데이터 시각화 (POST)
- 사용자: 정책기획관, 각 실·본부·국
- 데이터: 다중 공공데이터 통합 (파일 업로드 + 여러 API 조합)
- 제공 형태: 엑셀/CSV 파일 업로드 처리 + 각 데이터 소스별 API 호출
- 필요사항: 각 데이터 소스별 API키 (서울열린데이터, 공공데이터포털 등)

## 🔍 Function 생성 시 필수 검증 프로세스

### Phase 1: 요구사항 명확화
- 기능 요약 → Function 이름 제안 → 유저 승인
- 주요 사용자층, HTTP 메서드 (조회=GET, 파일업로드=POST)  
- 입출력 스펙 (필수/선택, 타입, 에러 처리)
- 외부 API 및 인증키 요구사항
- 보안 설정 (익명 허용, 도메인 제한)

### Phase 2: 기술적 타당성 검토
- Deno/Supabase 환경 호환성 확인
- 외부 API 접근 가능성 검증  
- 성능 제약사항 준수 (10초 실행시간, 6MB 요청/응답)
- API Key는 Supabase Secrets로 관리 가능한지 확인

### Phase 3: 구현 전 최종 확인  
- 3-Layer 구조 설계 완료
- lib.ts 함수 시그니처 정의
- CLI 테스트 시나리오 작성
- OpenAPI 스키마 업데이트 계획
- 유저 최종 승인 후 구현 시작

## 💬 역질문 템플릿

Function 생성 요청 시 다음 질문들로 요구사항을 명확히 하세요:

**기본 정보**
1. 기능을 한 문장으로 요약해주세요 (예: "서울시 구별 인구 데이터를 조회하는 기능")
   → 이를 바탕으로 function 이름을 제안드리겠습니다 (예: seoul-population-api)
2. 서울시 공무원 중 어떤 부서에서 주로 사용할 예정인가요?
3. 업무 자동화 목적인가요, 시민 서비스 제공용인가요?

**API 스펙**
4. 데이터 조회만 필요한가요?(GET) 파일 업로드도 필요한가요?(POST)
5. 필수 입력값과 선택 입력값을 구분해주세요
6. 에러 발생 시 어떤 정보를 반환해야 할까요?

**외부 의존성 & 보안**
7. 어떤 외부 서비스/API를 사용할 계획인가요?
8. 어떤 API Key들을 Supabase Secrets에 등록해야 하나요?
9. 익명 요청을 허용할 건가요? (기본값: 허용)

이 정보들을 확인한 후 정확히 구현해드리겠습니다.

## 🔄 개발 워크플로우

### 사전 준비
0. **Git 저장소 확인** → 프로젝트가 git 저장소가 아니라면 유저에게 확인 후 `git init` 실행

### 구현 단계  
1. **요구사항 확정** → 3단계 검증 프로세스 완료
2. **Function 이름 제안** → 기능 요약을 바탕으로 kebab-case 이름 제안 및 유저 승인
3. **API Key 등록** → `supabase secrets set API_KEY=value`  
4. **작은 단위 구현** → 10-20줄씩 lib.ts 작성 및 CLI 테스트
5. **HTTP 래퍼 작성** → index.ts에서 CORS, 에러 처리
6. **통합 테스트** → `supabase functions serve`로 검증
7. **문서 업데이트** → OpenAPI schema.json에 새 function 추가
8. **배포** → `supabase functions deploy` + 유저 승인 후 커밋

각 단계마다 동작 확인 필수. 문제 발견 시 즉시 롤백(`git reset --hard HEAD`) 후 재시작.

## ⚠️ 절대 원칙

- **한글 응답**: 항상 한글로 대답하고 소통
- **🚨 Deno 전용**: 모든 구현에 Deno만 사용, Node.js 절대 사용 금지
- **추측 금지**: 불분명한 요구사항은 반드시 재확인
- **작은 단위 개발**: 10-20줄 단위로 구현 및 동작 확인  
- **즉시 롤백**: 문제 발견 시 변경사항 폐기 후 재시작
- **유저 승인 필수**: 모든 커밋은 유저 확인 후 실행
- **보안 우선**: API Key는 반드시 Supabase Secrets로 관리
- **HTTP 메서드 준수**: 조회는 GET, 파일 업로드는 POST
- **fetch() 전용**: Puppeteer, Playwright 등 브라우저 라이브러리 사용 금지

## 🚨 주요 제약사항

**Supabase Edge Functions**:
- **런타임**: Deno 전용 (Node.js 사용 금지)
- 실행시간 10초, 메모리 512MB, 요청/응답 최대 6MB
- 브라우저 자동화 라이브러리 사용 불가 (Permission Denied)
- fetch() API로만 HTTP 요청 처리

**공공 데이터 API**: 
- 서울열린데이터광장 1000건/일, 기상청 1000건/시간 등 Rate Limit 존재

## 🎯 기대 효과
- 서울시 공무원을 위한 맞춤형 API 서비스 제공
- 체계적 검증을 통한 정확한 구현  
- 한 번에 배포 가능한 완성도 높은 코드
- 안전한 API Key 관리를 통한 보안 강화                      